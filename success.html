<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pagamento aprovado • VeganFit</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b0f14; color:#e7eef7; margin:0; display:grid; place-items:center; min-height:100vh;}
    .card{width:min(560px,92vw); background:#111826; border:1px solid #1f2a3a; border-radius:16px; padding:22px 18px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:18px; margin:0 0 6px}
    p{margin:0 0 14px; opacity:.9; line-height:1.45}
    .muted{opacity:.7; font-size:13px}
    .bar{height:10px; background:#0b1220; border:1px solid #1f2a3a; border-radius:999px; overflow:hidden}
    .bar > div{height:100%; width:30%; background:#3b82f6; border-radius:999px; animation:load 1.1s infinite ease-in-out}
    @keyframes load{0%{transform:translateX(-120%)} 100%{transform:translateX(420%)}}
    .btn{display:inline-block; padding:10px 12px; border-radius:12px; border:1px solid #2a3952; color:#e7eef7; text-decoration:none; background:#162235}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  </style>
</head>
<body>
  <div class="card">
    <h1>Pagamento aprovado ✅</h1>
    <p>Estamos ativando seu Premium. Isso costuma levar poucos segundos.</p>
    <div class="bar" aria-hidden="true"><div></div></div>
    <p class="muted" id="status">Validando…</p>
    <div class="row">
      <a class="btn" href="index.html?return=success">Ir para o site</a>
      <a class="btn" href="index.html">Home</a>
    </div>
  </div>

  <script>
    // Tenta descobrir email de forma “melhor esforço”
    function getEmailCandidate() {
      const url = new URL(location.href);
      const fromUrl = url.searchParams.get('email');
      const fromLs =
        localStorage.getItem('fit_user_email') ||
        localStorage.getItem('vf_user_email') ||
        localStorage.getItem('user_email');
      return (fromUrl || fromLs || '').trim().toLowerCase();
    }

    async function checkPremium(email) {
      const res = await fetch('/api/premium-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      return res.json();
    }

    (async function main(){
      const statusEl = document.getElementById('status');
      const email = getEmailCandidate();

      // Se não souber email, redireciona sem polling (o app resolve)
      if (!email) {
        statusEl.textContent = 'Quase lá… redirecionando.';
        setTimeout(() => location.replace('index.html?return=success'), 800);
        return;
      }

      // Polling: aguarda webhook gravar premium_users
      const maxMs = 25000;
      const start = Date.now();
      let tries = 0;

      while (Date.now() - start < maxMs) {
        tries++;
        try {
          statusEl.textContent = `Validando Premium… (tentativa ${tries})`;
          const data = await checkPremium(email);

          if (data && data.ok && data.premium === true) {
            statusEl.textContent = 'Premium ativado ✅ Redirecionando…';
            // redireciona com email para o app sincronizar sem reload
            setTimeout(() => {
              location.replace(`index.html?return=success&email=${encodeURIComponent(email)}`);
            }, 700);
            return;
          }
        } catch (e) {}

        await new Promise(r => setTimeout(r, 1500));
      }

      // Se não ativou a tempo, ainda assim volta pro app (ele pode tentar de novo)
      statusEl.textContent = 'Estamos finalizando… redirecionando.';
      setTimeout(() => location.replace(`index.html?return=success&email=${encodeURIComponent(email)}`), 1200);
    })();
  </script>
</body>
</html>
